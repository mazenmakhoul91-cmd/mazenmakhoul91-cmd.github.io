<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>حاسبة الراتب السنوية والمخططات التحليلية</title>
    <!-- تضمين خط Google Fonts: Cairo لخط عربي جميل -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <!-- تضمين مكتبة Chart.js للمخططات البيانية -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* تعريف متغيرات الألوان */
        :root {
            --primary-color: #4CAF50; /* أخضر */
            --secondary-color: #388E3C; /* أخضر داكن */
            --background-color: #f0f8f0; /* أخضر فاتح جداً */
            --text-color: #333;
            --light-text-color: #f9f9f9;
            --card-background: #ffffff;
            --border-color: #ddd;
            --button-hover-color: #2e7d32;
            --input-border-color: #ccc;
            --focus-border-color: #8BC34A;
            --table-header-bg: #e6ffe6; /* خلفية جدول فاتحة */
            --table-row-hover: #f0fff0; /* خلفية الصف عند التحويم */
            --chart-bg: #f5fbe5; /* خلفية قسم المخططات */
            --chart-border: #aed581; /* حدود قسم المخططات */
            --remove-btn-color: #dc3545; /* أحمر لزر الحذف */
            --remove-btn-hover-color: #c82333;
        }

        /* تنسيق عام للصفحة */
        body {
            font-family: 'Cairo', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .container {
            width: 90%;
            max-width: 900px;
            margin: 20px auto; /* تقليل الهامش العلوي والسفلي أكثر */
            padding: 15px; /* تقليل الحشوة الداخلية أكثر */
            background-color: var(--card-background);
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            text-align: right;
            border: 1px solid var(--border-color);
        }

        /* تنسيق الرأس (Header) */
        header {
            background-color: var(--primary-color);
            color: var(--light-text-color);
            padding: 15px 0; /* تقليل الحشوة أكثر */
            border-radius: 10px 10px 0 0;
            margin: -15px -15px 10px -15px; /* ضبط الهامش ليتناسب مع padding الجديد للحاوية */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        header h1 {
            margin: 0;
            font-size: 2.2em; /* تصغير طفيف */
            font-weight: 700;
            letter-spacing: 1px;
        }

        /* تنسيق حقول الإدخال لتكون في المنتصف */
        .input-options {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: 10px; /* تقليل الحشوة أكثر */
        }

        .input-group {
            margin-bottom: 10px; /* تقليل المسافة بين المجموعات أكثر */
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px; /* تقليل المسافة */
            font-size: 1em; /* تصغير طفيف */
            color: #555;
            font-weight: 600;
            text-align: right;
            width: 100%;
            max-width: 300px;
        }

        .input-group input[type="number"] {
            width: 100%;
            max-width: 300px;
            padding: 8px; /* تقليل الحشوة أكثر */
            border: 1px solid var(--input-border-color);
            border-radius: 8px;
            font-family: 'Cairo', sans-serif;
            font-size: 0.95em; /* تصغير طفيف */
            color: var(--text-color);
            text-align: right;
            box-sizing: border-box;
        }

        .input-group input[type="number"]:focus {
            outline: none;
            border-color: var(--focus-border-color);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
        }

        /* تنسيق الأزرار */
        .button {
            display: inline-block;
            background-color: var(--secondary-color);
            color: var(--light-text-color);
            padding: 8px 18px; /* تقليل الحشوة أكثر */
            border-radius: 8px;
            text-decoration: none;
            font-weight: 700;
            transition: background-color 0.3s ease, transform 0.2s ease;
            font-size: 0.95em; /* تصغير طفيف */
            border: none;
            cursor: pointer;
            margin-top: 8px; /* تقليل الهامش العلوي */
            margin-left: 6px; /* تقليل المسافة بين الأزرار */
        }

        .button:hover {
            background-color: var(--button-hover-color);
            transform: translateY(-2px);
        }

        /* تنسيق منطقة النتائج */
        #results-section {
            margin-top: 20px; /* تقليل الهامش العلوي أكثر */
            padding-top: 15px; /* تقليل الحشوة أكثر */
            border-top: 1px dashed var(--border-color);
            display: none;
        }

        #results-section h2 {
            color: var(--primary-color);
            font-size: 1.6em; /* تصغير طفيف */
            margin-bottom: 10px; /* تقليل المسافة أكثر */
            text-align: center;
        }

        #total-salary-display {
            background-color: var(--table-header-bg);
            padding: 10px; /* تقليل الحشوة أكثر */
            border-radius: 8px;
            margin-bottom: 15px; /* تقليل المسافة أكثر */
            font-size: 1.1em; /* تصغير طفيف */
            font-weight: 700;
            color: var(--secondary-color);
            text-align: center;
            border: 1px solid var(--primary-color);
        }

        /* تنسيق الجدول */
        .salary-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px; /* تقليل الهامش العلوي أكثر */
            font-size: 0.85em; /* تصغير طفيف */
        }

        .salary-table th, .salary-table td {
            border: 1px solid var(--border-color);
            padding: 8px; /* تقليل الحشوة أكثر */
            text-align: right;
        }

        /* تنسيق رسائل الخطأ */
        #error-message {
            color: #d32f2f;
            background-color: #ffebee;
            border: 1px solid #ef9a9a;
            padding: 8px;
            border-radius: 8px;
            margin-top: 10px;
            text-align: center;
            display: none;
        }

        /* تنسيق حقول الزيادات الإضافية المتعددة */
        .additional-increases-container {
            width: 100%;
            max-width: 400px;
            margin: 10px auto; /* تقليل الهامش أكثر */
            border: 1px dashed var(--border-color);
            border-radius: 8px;
            padding: 10px; /* تقليل الحشوة أكثر */
            background-color: var(--background-color);
            text-align: center;
        }

        .additional-increases-container h3 {
            color: var(--secondary-color);
            margin-top: 0;
            font-size: 1.05em; /* تصغير طفيف */
            text-align: center;
            margin-bottom: 8px; /* تقليل المسافة */
        }

        .additional-increase-item {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 6px; /* تقليل الفجوة أكثر */
            margin-bottom: 8px; /* تقليل المسافة */
            padding: 6px; /* تقليل الحشوة أكثر */
            border: 1px solid #eee;
            border-radius: 6px;
            background-color: var(--card-background);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .additional-increase-item input {
            width: calc(50% - 8px); /* ضبط العرض مع الفجوة الجديدة */
            max-width: 120px;
            padding: 5px; /* تقليل الحشوة أكثر */
            border: 1px solid var(--input-border-color);
            border-radius: 6px;
            font-family: 'Cairo', sans-serif;
            font-size: 0.85em; /* تصغير طفيف */
            text-align: right;
            box-sizing: border-box;
        }
        
        /* ضبط عرض مدخل السنة و النسبة ليكونوا بجانب بعضهم و متجاوبين */
        .additional-increase-item input[type="number"]:first-of-type {
            flex-grow: 1;
        }
        .additional-increase-item input[type="number"]:last-of-type {
            flex-grow: 1;
        }


        .remove-increase-btn {
            background-color: var(--remove-btn-color);
            color: var(--light-text-color);
            padding: 5px 8px; /* تقليل الحشوة أكثر */
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-size: 0.8em; /* تصغير طفيف */
            font-weight: 600;
        }

        .remove-increase-btn:hover {
            background-color: var(--remove-btn-hover-color);
        }

        #add-new-increase-btn {
            background-color: var(--primary-color);
            margin-top: 6px; /* تقليل الهامش */
            padding: 7px 12px; /* تقليل الحشوة */
            font-size: 0.9em; /* تصغير طفيف */
            width: auto;
        }

        /* تنسيقات قسم المخططات والنسب المئوية */
        .chart-analysis-section {
            margin-top: 20px; /* تقليل الهامش العلوي أكثر */
            padding: 15px; /* تقليل الحشوة أكثر */
            border: 1px solid var(--chart-border);
            border-radius: 12px;
            background-color: var(--chart-bg);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            text-align: center;
            display: none;
        }
        .chart-analysis-section h2 {
            color: var(--secondary-color);
            font-size: 1.6em; /* تصغير طفيف */
            margin-bottom: 10px; /* تقليل المسافة أكثر */
        }
        .percentage-display {
            margin-top: 10px; /* تقليل الهامش العلوي أكثر */
            margin-bottom: 10px; /* تقليل الهامش السفلي أكثر */
            font-size: 1em; /* تصغير طفيف */
            font-weight: 600;
            color: var(--secondary-color);
        }
        .percentage-item {
            margin-bottom: 6px; /* تقليل المسافة أكثر */
            padding: 6px; /* تقليل الحشوة أكثر */
            background-color: var(--background-color);
            border-radius: 5px;
            border: 1px dashed var(--border-color);
        }
        .chart-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px; /* تقليل الفجوة بين المخططات أكثر */
            margin-top: 10px; /* تقليل الهامش العلوي أكثر */
        }
        .chart-box {
            width: 100%;
            max-width: 400px;
            background-color: var(--card-background);
            padding: 10px; /* تقليل الحشوة أكثر */
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
        }
        canvas { /* التأكد من ضبط حجم الكانفاس لتجنب المسافات الزائدة */
            max-height: 250px; /* تحديد أقصى ارتفاع للمخطط */
            width: 100% !important;
            height: auto !important;
        }

        /* استجابة التصميم للشاشات الصغيرة */
        @media (max-width: 768px) {
            header h1 {
                font-size: 1.6em;
            }

            .container {
                margin: 10px auto;
                padding: 10px;
            }

            .input-group input[type="number"] {
                max-width: 100%;
            }

            .additional-increases-container {
                max-width: 100%;
                padding: 10px;
            }

            .additional-increase-item {
                flex-direction: column;
                gap: 5px;
            }
            .additional-increase-item input {
                width: 100%;
                max-width: none;
            }

            .salary-table {
                font-size: 0.75em;
            }

            .salary-table th, .salary-table td {
                padding: 5px;
            }
            .chart-box {
                max-width: 95%;
            }
        }

        /* تنسيقات خاصة بالطباعة */
        @media print {
            body {
                background-color: #fff;
                margin: 0;
                padding: 0;
                display: block;
            }
            .container {
                width: 100%;
                max-width: none;
                margin: 0;
                padding: 0;
                box-shadow: none;
                border: none;
                border-radius: 0;
            }
            header,
            p,
            .input-options,
            .button,
            #error-message,
            #add-new-increase-btn,
            .remove-increase-btn {
                display: none !important;
            }
            #results-section,
            .chart-analysis-section {
                display: block !important;
                margin-top: 10px; /* تقليل المسافة في الطباعة أكثر */
                padding-top: 0;
                border-top: none;
                box-shadow: none;
                border: none;
                background-color: #fff;
            }
            .salary-table {
                width: 100%;
                font-size: 0.8em; /* تصغير خط الجدول أكثر */
            }
            .salary-table th, .salary-table td {
                padding: 6px; /* ضبط حشوة الخلايا */
                border: 1px solid #000;
            }
            #total-salary-display {
                background-color: #f0f0f0;
                color: #000;
                border: 1px solid #ccc;
                font-size: 0.95em; /* تصغير خط الإجمالي */
            }
            .chart-box {
                max-width: 100%;
                page-break-inside: avoid;
                margin-bottom: 10px; /* مسافة بسيطة بين المخططات المطبوعة */
                padding: 5px; /* تقليل حشوة المخططات في الطباعة */
            }
            canvas {
                max-width: 100% !important;
                height: 200px !important; /* تحديد ارتفاع ثابت للمخطط في الطباعة */
            }
            /* إزالة أي خلفيات ملونة للمخططات في الطباعة لتوفير الحبر */
            .chart-analysis-section, .chart-box {
                background-color: #fff !important;
            }
            .chart-container {
                gap: 5px; /* تقليل الفجوة في الطباعة */
                margin-top: 5px;
            }
            .percentage-display {
                margin-top: 10px;
                margin-bottom: 10px;
            }
            .percentage-item {
                padding: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>حاسبة الراتب السنوية المتقدمة 💰</h1>
        </header>

        <p>
            هذه الأداة تساعدك على تقدير نمو راتبك الأساسي على مدار سنوات محددة، مع الأخذ في الاعتبار نسبة زيادة سنوية ثابتة وزيادات إضافية دورية أو لمرة واحدة في سنوات محددة.
            أدخل التفاصيل للحصول على التوقعات المفصلة.
        </p>

        <div class="input-options">
            <div class="input-group">
                <label for="basic-salary">الراتب الأساسي الحالي (دينار أردني):</label>
                <input type="number" id="basic-salary" value="500" min="0">
            </div>

            <div class="input-group">
                <label for="annual-increase">نسبة الزيادة السنوية العادية (٪):</label>
                <input type="number" id="annual-increase" value="5" min="0" step="0.1">
            </div>

            <div class="input-group">
                <label for="number-of-years">عدد سنوات الحساب:</label>
                <input type="number" id="number-of-years" value="30" min="1" max="100">
            </div>

            <div class="input-group">
                <label for="start-year">سنة البدء (مثال: 2026):</label>
                <input type="number" id="start-year" value="2026" min="1900" max="2100">
            </div>

            <div class="additional-increases-container">
                <h3>الزيادات الإضافية المخصصة</h3>
                <p>أدخل السنة الفعلية (مثال: 2030) ونسبة الزيادة لتطبيق زيادة إضافية لمرة واحدة.</p>
                <div id="dynamic-additional-increases">
                    <!-- سيتم إضافة حقول الزيادة هنا بواسطة JavaScript -->
                </div>
                <button id="add-new-increase-btn" class="button" style="margin-left: 0;">+ إضافة زيادة جديدة</button>
            </div>
        </div>

        <button id="calculate-btn" class="button">احسب الراتب 📈</button>
        <button id="print-btn" class="button">طباعة النتائج 🖨️</button>

        <div id="error-message"></div>

        <div id="results-section">
            <h2>تفاصيل الراتب السنوية</h2>
            <div id="total-salary-display"></div>
            <table class="salary-table">
                <thead>
                    <tr>
                        <th>العام</th>
                        <th>الراتب في بداية العام</th>
                        <th>مبلغ الزيادة السنوية</th>
                        <th>الراتب في نهاية العام</th>
                    </tr>
                </thead>
                <tbody id="salary-table-body">
                    <!-- سيتم تعبئة البيانات هنا بواسطة JavaScript -->
                </tbody>
            </table>

            <!-- قسم المخططات والنسب المئوية -->
            <div class="chart-analysis-section" id="chart-analysis-section">
                <h2>📊 تحليل مرئي لنمو الراتب 📊</h2>
                <div class="percentage-display">
                    <div class="percentage-item">
                        <p><strong>الزيادة السنوية الشاملة للراتب:</strong> <span id="overall-annual-increase-percentage">0%</span></p>
                    </div>
                    <div class="percentage-item">
                        <p><strong>مساهمة الزيادات الإضافية من الراتب الأساسي:</strong> <span id="overall-additional-increase-percentage">0%</span></p>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-box">
                        <h3>توزيع الراتب الإجمالي المتوقع</h3>
                        <canvas id="totalSalaryBreakdownChart"></canvas>
                    </div>
                    <div class="chart-box">
                        <h3>الراتب المتوقع في نهاية كل عام</h3>
                        <canvas id="salaryProgressionChart"></canvas> <!-- تم تغيير المعرف -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const basicSalaryInput = document.getElementById('basic-salary');
            const annualIncreaseInput = document.getElementById('annual-increase');
            const numberOfYearsInput = document.getElementById('number-of-years');
            const startYearInput = document.getElementById('start-year');
            
            const dynamicAdditionalIncreasesDiv = document.getElementById('dynamic-additional-increases');
            const addNewIncreaseButton = document.getElementById('add-new-increase-btn');

            const calculateButton = document.getElementById('calculate-btn');
            const printButton = document.getElementById('print-btn');
            const resultsSection = document.getElementById('results-section');
            const totalSalaryDisplay = document.getElementById('total-salary-display');
            const salaryTableBody = document.getElementById('salary-table-body');
            const errorMessage = document.getElementById('error-message');
            
            const chartAnalysisSection = document.getElementById('chart-analysis-section');
            const overallAnnualIncreasePercentageSpan = document.getElementById('overall-annual-increase-percentage');
            const overallAdditionalIncreasePercentageSpan = document.getElementById('overall-additional-increase-percentage');

            let finalSalaryAfterCalculationYears = 0;
            let totalAccumulatedSalaryValue = 0;
            let totalNormalIncreasesAmount = 0;
            let totalAdditionalIncreasesAmount = 0;
            let currentNumberOfYears = 0;
            let currentStartYear = 0;
            let additionalIncreasesData = [];
            let annualEndSalariesForChart = []; // جديد لتخزين الرواتب النهائية لكل عام للمخطط الشريطي
            let chartYearsLabels = []; // جديد لتخزين تسميات السنوات للمخطط الشريطي

            let totalSalaryBreakdownChartInstance = null;
            let salaryProgressionChartInstance = null; // تم تغيير اسم المتغير

            // دالة لتنسيق الأرقام كعملة (دينار أردني)
            function formatCurrency(amount) {
                return new Intl.NumberFormat('ar-JO', {
                    style: 'currency',
                    currency: 'JOD',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(amount);
            }

            // دالة لإضافة حقل زيادة إضافية جديد
            function addIncreaseEntry() {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'additional-increase-item';

                const yearInput = document.createElement('input');
                yearInput.type = 'number';
                yearInput.className = 'increase-year';
                yearInput.placeholder = 'السنة الفعلية (مثال: 2030)';
                const defaultYear = parseInt(startYearInput.value) || new Date().getFullYear();
                yearInput.min = defaultYear.toString();
                yearInput.value = defaultYear + (additionalIncreasesData.length + 1) * 5; 
                yearInput.required = true;

                const percentInput = document.createElement('input');
                percentInput.type = 'number';
                percentInput.className = 'increase-percent';
                percentInput.placeholder = 'النسبة % (مثال: 10)';
                percentInput.min = '0';
                percentInput.step = '0.1';
                percentInput.value = '2';
                percentInput.required = true;

                const removeButton = document.createElement('button');
                removeButton.className = 'remove-increase-btn';
                removeButton.textContent = 'X';
                removeButton.addEventListener('click', () => {
                    itemDiv.remove();
                    updateAdditionalIncreasesData();
                });

                itemDiv.appendChild(yearInput);
                itemDiv.appendChild(percentInput);
                itemDiv.appendChild(removeButton);
                dynamicAdditionalIncreasesDiv.appendChild(itemDiv);

                updateAdditionalIncreasesData();

                yearInput.addEventListener('input', updateAdditionalIncreasesData);
                percentInput.addEventListener('input', updateAdditionalIncreasesData);
            }

            // دالة لتحديث مصفوفة الزيادات الإضافية بناءً على حقول الإدخال الحالية
            function updateAdditionalIncreasesData() {
                additionalIncreasesData = [];
                const items = dynamicAdditionalIncreasesDiv.querySelectorAll('.additional-increase-item');
                items.forEach(item => {
                    const actualYear = parseInt(item.querySelector('.increase-year').value);
                    const percent = parseFloat(item.querySelector('.increase-percent').value);

                    if (!isNaN(actualYear) && actualYear >= 1 && !isNaN(percent) && percent >= 0) {
                        additionalIncreasesData.push({ actualYear: actualYear, percent: percent });
                    }
                });
                additionalIncreasesData.sort((a, b) => a.actualYear - b.actualYear);
            }

            // دالة لإنشاء أو تحديث المخططات
            function updateCharts(basicSalary, totalNormalIncreases, totalAdditionalIncreases, yearsLabels, annualSalaries) {
                const ctx1 = document.getElementById('totalSalaryBreakdownChart').getContext('2d');
                const ctx2 = document.getElementById('salaryProgressionChart').getContext('2d'); // تم تغيير المعرف

                // تدمير المخططات الموجودة قبل إنشاء مخططات جديدة لتجنب التراكب
                if (totalSalaryBreakdownChartInstance) {
                    totalSalaryBreakdownChartInstance.destroy();
                }
                if (salaryProgressionChartInstance) { // تم تغيير اسم المتغير
                    salaryProgressionChartInstance.destroy();
                }

                // المخطط الأول: توزيع الراتب الإجمالي (Doughnut Chart)
                totalSalaryBreakdownChartInstance = new Chart(ctx1, {
                    type: 'doughnut',
                    data: {
                        labels: ['الراتب الأساسي', 'الزيادات السنوية العادية', 'الزيادات الإضافية المخصصة'],
                        datasets: [{
                            data: [basicSalary, totalNormalIncreases, totalAdditionalIncreases],
                            backgroundColor: [
                                '#4CAF50', // Primary Color - Green
                                '#FFC107', // Amber - Yellow/Orange
                                '#03A9F4'  // Light Blue - Blue
                            ],
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    font: {
                                        family: 'Cairo',
                                        size: 14
                                    }
                                }
                            },
                            title: {
                                display: true,
                                text: 'توزيع الراتب الإجمالي المتوقع',
                                font: {
                                    family: 'Cairo',
                                    size: 16,
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                });

                // المخطط الثاني: الراتب المتوقع في نهاية كل عام (Bar Chart)
                salaryProgressionChartInstance = new Chart(ctx2, { // تم تغيير اسم المتغير
                    type: 'bar', // مخطط شريطي
                    data: {
                        labels: yearsLabels, // سنوات العرض
                        datasets: [{
                            label: 'الراتب في نهاية العام (دينار أردني)',
                            data: annualSalaries, // الرواتب السنوية
                            backgroundColor: '#4CAF50', // استخدام اللون الأساسي
                            borderColor: '#388E3C',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false, // لا حاجة لعنوان للبيانات
                                labels: {
                                    font: {
                                        family: 'Cairo',
                                        size: 14
                                    }
                                }
                            },
                            title: {
                                display: true,
                                text: 'الراتب المتوقع في نهاية كل عام',
                                font: {
                                    family: 'Cairo',
                                    size: 16,
                                    weight: 'bold'
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'الراتب (دينار أردني)',
                                    font: {
                                        family: 'Cairo',
                                        size: 14
                                    }
                                },
                                ticks: {
                                    callback: function(value, index, values) {
                                        return formatCurrency(value); // تنسيق الأرقام كعملة على المحور Y
                                    },
                                    font: {
                                        family: 'Cairo'
                                    }
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'السنة',
                                    font: {
                                        family: 'Cairo',
                                        size: 14
                                    }
                                },
                                ticks: {
                                    font: {
                                        family: 'Cairo'
                                    }
                                }
                            }
                        }
                    }
                });
            }


            addNewIncreaseButton.addEventListener('click', addIncreaseEntry);

            calculateButton.addEventListener('click', () => {
                errorMessage.style.display = 'none';
                chartAnalysisSection.style.display = 'none';

                const basicSalary = parseFloat(basicSalaryInput.value);
                const annualIncreaseRate = parseFloat(annualIncreaseInput.value) / 100;
                const numberOfYears = parseInt(numberOfYearsInput.value);
                const startYear = parseInt(startYearInput.value);
                
                updateAdditionalIncreasesData();

                // التحقق من صحة المدخلات الأساسية
                if (isNaN(basicSalary) || basicSalary < 0 ||
                    isNaN(annualIncreaseRate) || annualIncreaseRate < 0 ||
                    isNaN(numberOfYears) || numberOfYears < 1 || numberOfYears > 100 ||
                    isNaN(startYear) || startYear < 1900 || startYear > 2100) {
                    errorMessage.textContent = 'الرجاء إدخال أرقام صحيحة وموجبة في الحقول الأساسية. عدد السنوات بين 1 و 100، وسنة البدء بين 1900 و 2100.';
                    errorMessage.style.display = 'block';
                    resultsSection.style.display = 'none';
                    return;
                }

                // التحقق من صحة مدخلات الزيادات الإضافية
                let validAdditionalIncreases = true;
                additionalIncreasesData.forEach(item => {
                    if (isNaN(item.actualYear) || item.actualYear < startYear || item.actualYear > (startYear + numberOfYears -1) || isNaN(item.percent) || item.percent < 0) {
                        validAdditionalIncreases = false;
                        errorMessage.textContent = 'الرجاء التأكد من صحة جميع قيم الزيادات الإضافية: السنة يجب أن تكون ضمن نطاق سنوات الحساب والنسبة موجبة.';
                        errorMessage.style.display = 'block';
                        resultsSection.style.display = 'none';
                    }
                });
                if (!validAdditionalIncreases) {
                    return;
                }

                salaryTableBody.innerHTML = '';
                let currentSalary = basicSalary;
                let totalAccumulated = 0;
                totalNormalIncreasesAmount = 0;
                totalAdditionalIncreasesAmount = 0;
                currentNumberOfYears = numberOfYears;
                currentStartYear = startYear;
                annualEndSalariesForChart = []; // إعادة تعيين لبيانات المخطط الشريطي
                chartYearsLabels = []; // إعادة تعيين لتسميات سنوات المخطط الشريطي


                for (let i = 0; i < numberOfYears; i++) {
                    const displayYear = startYear + i;
                    const salaryAtStartOfYear = currentSalary;

                    let currentAnnualIncrement = currentSalary * annualIncreaseRate;
                    totalNormalIncreasesAmount += currentAnnualIncrement; 

                    // تطبيق الزيادات الإضافية المخصصة لهذا العام الفعلي
                    const applicableAdditionalIncreases = additionalIncreasesData.filter(item => item.actualYear === displayYear);
                    applicableAdditionalIncreases.forEach(item => {
                        const additionalAmount = currentSalary * (item.percent / 100);
                        currentAnnualIncrement += additionalAmount;
                        totalAdditionalIncreasesAmount += additionalAmount; 
                    });

                    const endOfYearSalary = currentSalary + currentAnnualIncrement;
                    
                    totalAccumulated += (endOfYearSalary * 12); 

                    const row = salaryTableBody.insertRow();
                    row.insertCell(0).textContent = displayYear;
                    row.insertCell(1).textContent = formatCurrency(salaryAtStartOfYear);
                    row.insertCell(2).textContent = formatCurrency(currentAnnualIncrement);
                    row.insertCell(3).textContent = formatCurrency(endOfYearSalary);

                    currentSalary = endOfYearSalary;

                    annualEndSalariesForChart.push(endOfYearSalary); // تخزين الراتب النهائي للمخطط
                    chartYearsLabels.push(displayYear); // تخزين السنة للمخطط
                }

                finalSalaryAfterCalculationYears = currentSalary;
                totalAccumulatedSalaryValue = totalAccumulated;

                // حساب النسب المئوية الشاملة
                const overallAnnualIncreasePercentage = ((finalSalaryAfterCalculationYears / basicSalary) - 1) * 100;
                const overallAdditionalIncreasePercentage = (totalAdditionalIncreasesAmount / basicSalary) * 100;
                
                overallAnnualIncreasePercentageSpan.textContent = `${overallAnnualIncreasePercentage.toFixed(2)}%`;
                overallAdditionalIncreasePercentageSpan.textContent = `${overallAdditionalIncreasePercentage.toFixed(2)}%`;


                totalSalaryDisplay.textContent = `إجمالي الراتب التراكمي خلال ${numberOfYears} عاماً (من ${startYear} حتى ${startYear + numberOfYears - 1}): ${formatCurrency(totalAccumulatedSalaryValue)}`;
                resultsSection.style.display = 'block';
                chartAnalysisSection.style.display = 'block';

                // تحديث المخططات
                updateCharts(basicSalary, totalNormalIncreasesAmount, totalAdditionalIncreasesAmount, chartYearsLabels, annualEndSalariesForChart);
            });

            // وظيفة زر الطباعة
            printButton.addEventListener('click', () => {
                window.print();
            });

            // إضافة زيادتين افتراضيتين عند التحميل
            addIncreaseEntry();
            addIncreaseEntry();

            // تشغيل الحساب عند تحميل الصفحة بالقيم الافتراضية
            calculateButton.click();
        });
    </script>
</body>
</html>
